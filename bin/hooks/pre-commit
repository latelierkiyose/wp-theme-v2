#!/bin/bash
# Pre-commit hook for L'Atelier Kiyose WordPress theme
# Runs PHPCS, ESLint, and Stylelint checks on staged files

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}Running pre-commit checks...${NC}\n"

# Track if any checks failed
CHECKS_FAILED=0

# Get list of staged PHP files
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.php$' | grep '^latelierkiyose/' || true)

# Get list of staged JS files
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.js$' | grep '^latelierkiyose/assets/js/' || true)

# Get list of staged CSS files
STAGED_CSS_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.css$' | grep '^latelierkiyose/' || true)

# ============================================
# Auto-fix linting issues (PHPCS + ESLint + Stylelint)
# ============================================
echo -e "${YELLOW}Auto-fixing linting issues...${NC}"

# Fix PHP files with PHPCBF
if [ -n "$STAGED_PHP_FILES" ]; then
	echo -e "${YELLOW}→ Fixing PHP files with PHPCBF...${NC}"
	if [ -f "./bin/phpcbf.sh" ]; then
		# Use Docker wrapper
		./bin/phpcbf.sh --standard=phpcs.xml $STAGED_PHP_FILES || true
		git add $STAGED_PHP_FILES
		echo -e "${GREEN}✓ PHP files auto-fixed and re-staged${NC}"
	elif command -v vendor/bin/phpcbf &> /dev/null; then
		# Use local vendor installation
		vendor/bin/phpcbf --standard=phpcs.xml $STAGED_PHP_FILES || true
		git add $STAGED_PHP_FILES
		echo -e "${GREEN}✓ PHP files auto-fixed and re-staged${NC}"
	else
		echo -e "${YELLOW}⚠ PHPCBF not found, skipping PHP auto-fix${NC}"
	fi
fi

# Fix JS and CSS files with ESLint + Stylelint
if [ -n "$STAGED_JS_FILES" ] || [ -n "$STAGED_CSS_FILES" ]; then
	if command -v npm &> /dev/null; then
		echo -e "${YELLOW}→ Fixing JS/CSS files with ESLint + Stylelint...${NC}"
		# Run lint:fix to automatically fix ESLint and Stylelint issues
		npm run lint:fix --silent || true

		# Re-stage the fixed files
		if [ -n "$STAGED_JS_FILES" ]; then
			git add $STAGED_JS_FILES
		fi
		if [ -n "$STAGED_CSS_FILES" ]; then
			git add $STAGED_CSS_FILES
		fi
		echo -e "${GREEN}✓ JS/CSS files auto-fixed and re-staged${NC}"
	else
		echo -e "${YELLOW}⚠ npm not found, skipping JS/CSS auto-fix${NC}"
	fi
fi

echo -e "${GREEN}✓ Auto-fix completed${NC}\n"

# ============================================
# PHP CodeSniffer (PHPCS)
# ============================================
if [ -n "$STAGED_PHP_FILES" ]; then
	echo -e "${YELLOW}Checking PHP files with PHPCS...${NC}"
	
	# Check if running in Docker environment or local
	if [ -f "./bin/phpcs.sh" ]; then
		# Use Docker wrapper
		if ! ./bin/phpcs.sh --standard=phpcs.xml $STAGED_PHP_FILES; then
			echo -e "${RED}✗ PHPCS check failed!${NC}"
			echo -e "${YELLOW}Run 'make phpcs-fix' to auto-fix issues, or 'make phpcs' to see details.${NC}\n"
			CHECKS_FAILED=1
		else
			echo -e "${GREEN}✓ PHPCS check passed${NC}\n"
		fi
	elif command -v vendor/bin/phpcs &> /dev/null; then
		# Use local vendor installation
		if ! vendor/bin/phpcs --standard=phpcs.xml $STAGED_PHP_FILES; then
			echo -e "${RED}✗ PHPCS check failed!${NC}"
			echo -e "${YELLOW}Run 'vendor/bin/phpcbf --standard=phpcs.xml' to auto-fix issues.${NC}\n"
			CHECKS_FAILED=1
		else
			echo -e "${GREEN}✓ PHPCS check passed${NC}\n"
		fi
	else
		echo -e "${RED}✗ PHPCS not found! Run 'make install' or 'composer install'${NC}\n"
		CHECKS_FAILED=1
	fi
else
	echo -e "${YELLOW}No PHP files to check${NC}\n"
fi

# ============================================
# ESLint (JavaScript)
# ============================================
if [ -n "$STAGED_JS_FILES" ]; then
	echo -e "${YELLOW}Checking JavaScript files with ESLint...${NC}"
	
	if command -v npm &> /dev/null; then
		if ! npx eslint $STAGED_JS_FILES; then
			echo -e "${RED}✗ ESLint check failed!${NC}"
			echo -e "${YELLOW}Run 'npm run lint:fix' to auto-fix issues.${NC}\n"
			CHECKS_FAILED=1
		else
			echo -e "${GREEN}✓ ESLint check passed${NC}\n"
		fi
	else
		echo -e "${RED}✗ npm not found! Install Node.js and run 'npm install'${NC}\n"
		CHECKS_FAILED=1
	fi
else
	echo -e "${YELLOW}No JavaScript files to check${NC}\n"
fi

# ============================================
# Stylelint (CSS)
# ============================================
if [ -n "$STAGED_CSS_FILES" ]; then
	echo -e "${YELLOW}Checking CSS files with Stylelint...${NC}"
	
	if command -v npm &> /dev/null; then
		if ! npx stylelint $STAGED_CSS_FILES; then
			echo -e "${RED}✗ Stylelint check failed!${NC}"
			echo -e "${YELLOW}Run 'npm run lint:css -- --fix' to auto-fix issues.${NC}\n"
			CHECKS_FAILED=1
		else
			echo -e "${GREEN}✓ Stylelint check passed${NC}\n"
		fi
	else
		echo -e "${RED}✗ npm not found! Install Node.js and run 'npm install'${NC}\n"
		CHECKS_FAILED=1
	fi
else
	echo -e "${YELLOW}No CSS files to check${NC}\n"
fi

# ============================================
# Final result
# ============================================
if [ $CHECKS_FAILED -eq 1 ]; then
	echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
	echo -e "${RED}Commit aborted: Fix the errors above before committing.${NC}"
	echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
	exit 1
else
	echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
	echo -e "${GREEN}All checks passed! ✓${NC}"
	echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
	exit 0
fi
