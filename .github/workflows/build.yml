name: Build and Test

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

jobs:
  test:
    name: Tests (PHPCS + PHPUnit + Linters)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'

      - name: Cache Composer dependencies
        uses: actions/cache@v5
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Validate composer.json
        run: composer validate --strict

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress

      - name: Install npm dependencies
        run: npm ci

      - name: Run PHPCS
        run: ./vendor/bin/phpcs

      - name: Run ESLint
        run: npm run lint:js

      - name: Run Stylelint
        run: npm run lint:css

      - name: Run PHPUnit
        run: |
          if [ -f "phpunit.xml" ]; then
            ./vendor/bin/phpunit
          else
            echo "No PHPUnit configuration found, skipping tests"
          fi

  build:
    name: Build Theme Artifact
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install npm dependencies
        run: npm ci

      - name: Build minified assets
        run: npm run build

      - name: Create build directory
        run: mkdir -p build

      - name: Copy theme files
        run: |
          rsync -av --exclude-from=.github/workflows/build-exclude.txt latelierkiyose/ build/latelierkiyose/

      - name: Create ZIP artifact
        run: |
          cd build
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          DATE=$(date +'%Y-%m-%d')
          zip -r latelierkiyose-theme-${DATE}-${SHORT_SHA}.zip latelierkiyose/
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: theme-build-${{ github.sha }}
          path: build/latelierkiyose-theme-*.zip
          retention-days: 5

      - name: Generate release tag
        id: release_tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          DATE=$(date +'%Y-%m-%d')
          TAG="build-${DATE}-${SHORT_SHA}"
          ZIPNAME="latelierkiyose-theme-${DATE}-${SHORT_SHA}.zip"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          echo "zipname=${ZIPNAME}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          name: "Build ${{ steps.release_tag.outputs.date }}"
          body: |
            Automated build from commit ${{ github.sha }}
            
            **Branch**: ${{ github.ref_name }}
            **Commit**: ${{ github.sha }}
            **Date**: ${{ steps.release_tag.outputs.date }}
            
            ## ðŸ“¦ Download the WordPress Theme
            
            **â¬‡ï¸ Download this file**: `${{ steps.release_tag.outputs.zipname }}`
            
            âš ï¸ **Important**: Do NOT download "Source code (zip)" or "Source code (tar.gz)" - these contain the entire repository, not just the theme.
            
            The theme ZIP contains only the `latelierkiyose/` folder ready to upload to WordPress.
          files: build/${{ steps.release_tag.outputs.zipname }}
          prerelease: true
          draft: false

      - name: Cleanup old releases
        uses: actions/github-script@v8
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // Filter only build releases (pre-releases starting with "build-")
            const buildReleases = releases
              .filter(r => r.prerelease && r.tag_name.startsWith('build-'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Keep only the 5 most recent, delete the rest
            const releasesToDelete = buildReleases.slice(5);
            
            for (const release of releasesToDelete) {
              console.log(`Deleting release: ${release.tag_name}`);
              
              // Delete the release
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id
              });
              
              // Delete the associated tag
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `tags/${release.tag_name}`
                });
              } catch (error) {
                console.log(`Could not delete tag ${release.tag_name}: ${error.message}`);
              }
            }
            
            console.log(`Kept ${Math.min(buildReleases.length, 5)} releases, deleted ${releasesToDelete.length}`);

